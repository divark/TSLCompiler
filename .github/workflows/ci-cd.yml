on: [push]

name: Continuous Integration / Continuous Deployment (Unix-based)

jobs:
  check:
    name: Verify code behaves as intended
    strategy:
      matrix:
        os: [ubuntu-22.04, macos-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Install dependencies for the project (macOS, Linux)
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            pipx install meson
            sudo apt update && sudo apt install bison flex cmake libfl-dev
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew upgrade && brew install meson bison flex
            # on macOS, bison and flex are already provided, but we want
            # to use the newer versions provided by Homebrew, so we have
            # to append them into the path via GitHub's GITHUB_PATH variable.
            echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH
            echo "$(brew --prefix flex)/bin" >> $GITHUB_PATH
            # Likewise, we want to use the latest header files for flex.
            echo "LDFLAGS=-L$(brew --prefix flex)/lib" >> $GITHUB_ENV
            # And besides importing the flex headers, also make a universal binary.
            echo "CPPFLAGS=-I$(brew --prefix flex)/include -arch arm64 -arch x86_64" >> $GITHUB_ENV
            # Finally, we want to support macOS since Big Sur.
            echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV
          fi

      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Setup build directory
        run: |
          meson wrap install fmt
          meson setup build

      - name: Run all tests
        run: meson test -C build

  upload:
    name: Upload compiled binaries
    needs: check
    strategy:
      matrix:
        os: [ubuntu-22.04, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Install dependencies for the project (macOS, Linux)
        run: |
          if [ "$RUNNER_OS" == "Linux" ]; then
            pipx install meson
            sudo apt update && sudo apt install libbison-dev bison flex cmake libfl-dev
            echo "LDFLAGS=-static-libstdc++" >> $GITHUB_ENV
          elif [ "$RUNNER_OS" == "macOS" ]; then
            brew upgrade && brew install meson bison flex
            # on macOS, bison and flex are already provided, but we want
            # to use the newer versions provided by Homebrew, so we have
            # to append them into the path via GitHub's GITHUB_PATH variable.
            echo "$(brew --prefix bison)/bin" >> $GITHUB_PATH
            echo "$(brew --prefix flex)/bin" >> $GITHUB_PATH
            # Likewise, we want to use the latest header files for flex.
            echo "LDFLAGS=-L$(brew --prefix flex)/lib" >> $GITHUB_ENV
            # And besides importing the flex headers, also make a universal binary.
            echo "CPPFLAGS=-I$(brew --prefix flex)/include -arch arm64 -arch x86_64" >> $GITHUB_ENV
            # Finally, we want to support macOS since Big Sur.
            echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV
          fi

      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Setup build directory
        run: |
          meson wrap install fmt
          meson setup build -Dbuild_for_release=true

      - name: Compile the project
        run: meson compile -C build

      - name: Strip unnecessary bits from TSLChecker
        run: strip build/tslchecker

      - name: Upload TSLChecker binary
        uses: actions/upload-artifact@v4
        with:
          path: build/tslchecker
          name: tslchecker-${{ matrix.os }}
